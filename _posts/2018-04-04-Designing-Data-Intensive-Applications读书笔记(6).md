---
layout: post
title:  "Designing Data-Intensive Applications读书笔记(6)"
categories: DDIA
tags:  读书笔记 分布式
author: Borui
---

* content
{:toc}

# Partitioning
当数据集非常非常大,并且我们需要非常高的吞吐量,我们就需要对数据集进行分片.每份数据都唯一的属于某个数据分区,每个数据分区都是整个大数据集的一小部分.

对数据集进行分区主要是为了可扩展性.不同的分区可以放置在无状态集群的不同节点上,于是一个大的数据集就被放置到许多不同的磁盘上,查询操作被分摊到不同的cpu上.

## Partitioning and Replication
分区往往和副本复制在一起工作,最终结果就是不同分区的不同副本分布在不同的节点上.这意味着,一条记录属于一个指定的分区,并且通过存储在不同的节点上来进行容错.

而一个节点上同样存储有不同的分区数据.如果是一个单主架构,那么分区+复制架构如图:
![Figure 6-1. Combining replication and partitioning: each node acts as leader for some partitions and follower for other partitions.](https://raw.githubusercontent.com/codeborui/codeborui.github.io/master/img/5.jpg)
每个分区的leader被分到一个节点上,它的follower被分配到其他节点上,因此每个节点可能是某个分区的leader,也可能是某个分区的follower.

## Partitioning of Key-Value Data
分区的目标是想将数据和查询尽可能的均衡的分布在节点上.这样可以得到线性的性能提升.但是如果分配不均匀,例如部分分区分配的数据量过多,则为产生**倾斜**,极端情况数据都分派到一台节点上,拥有不成比例的高负载的分区称为**热点**.最简单的方式,就是将节点随机分配,但是这种方法有个巨大的缺点,就是当你想要读取特定数据时,你找不到他在哪个分区上.

### Partitioning by Key Range
一种分区方式是,将连续范围的key分配到一个分区里.key的分布不一定是均匀的,因为数据并不一定均匀分布.为了使得数据最终能够均匀分区,因此分区的边界需要根据数据来定.分区的边界可以通过管理员来手工指定,也可以自动来选择.在每个分区里,我们会保持key的有序性,因此我们可以很方便的进行范围查询操作,也可以把kye当做组合索引来查询相关数据(例如key的值是通过年-月-日-时-分-秒这种形式).

不过这种方式的劣势也很明显,就是某种特定的查询模式将导致热点的出现,例如我们的key是时间戳形式,那么我们将频繁写入和查询最近时间戳所在的分区上,而其他分区则都是空闲状态.为了避免这种情况,你需要小心设计key值,key的开始元素可以根据实际情况选定特定分类,这样写入和查询就可以均匀分不到不同的分区上,只是获取某些数据时,需要合并各个分区查询的结果.

### Partitioning by Hash of Key
由于存在数据倾斜和热点问题,很多数据库采用hash函数来决定数据的分区.一个好的hash函数能使得倾斜的数据得到均匀的分布.由于只是为了分区,因此key值不需要被强加密,因此md5或者FowlerNoll–Vo函数都可以被采用.许多语言内置了简单hash函数,但不见得适用,因为同一个key值在不同的线程里可能都会有不同的hash值.当选定一个hash函数后,就可以给不同的分区指定不同的hash范围了.分区的边界可以是均匀间隔的,也可以是伪随机的(一致性hash).

一致性hash通过随机选择分区边界来避免中心控制和分布式一致性问题.事实上这种方式效果并不好,很多数据库的文档还称一致性hash其实是不准确的.

不过,通过这种方式,我们没有办法做key的范围查询了,并且分区内的key也不是有序的了.想做范围查询,就需要查询各个分区然后组合结果返回.

Cassandra提供了一种组合两种分区策略的方式,叫做复合主键.复合主键包含若干数据列,只用key的第一部分来进行hash分区,其他的列则用来排序.这样一来虽然无法通过第一列来进行范围查询,但是如果通过为第一列指定特定值,那么通过其他列就可以实现范围查询.